#!/usr/bin/make -f
# CX Core Package Build Rules
# Copyright 2025 AI Venture Holdings LLC
# SPDX-License-Identifier: BUSL-1.1

export PYBUILD_NAME=cx-linux
export DH_VERBOSE=1

%:
	dh $@ --with python3 --buildsystem=pybuild

override_dh_auto_build:
	dh_auto_build
	# Build Python package
	python3 setup.py build || python3 -m build --wheel --no-isolation

override_dh_auto_install:
	dh_auto_install

	# Create configuration directories
	install -d $(CURDIR)/debian/cx-core/etc/cx
	install -d $(CURDIR)/debian/cx-core/etc/cx/profiles.d
	install -d $(CURDIR)/debian/cx-core/var/lib/cx
	install -d $(CURDIR)/debian/cx-core/var/log/cx
	install -d $(CURDIR)/debian/cx-core/var/cache/cx
	install -d $(CURDIR)/debian/cx-core/usr/share/cx
	install -d $(CURDIR)/debian/cx-core/usr/share/doc/cx-core

	# Install default configuration
	install -m 644 debian/cx.yaml \
		$(CURDIR)/debian/cx-core/etc/cx/cx.yaml

	# Ensure cx CLI is in /usr/bin
	install -d $(CURDIR)/debian/cx-core/usr/bin

	# Create wrapper script if pip install didn't create it
	if [ ! -f $(CURDIR)/debian/cx-core/usr/bin/cx ]; then \
		echo '#!/usr/bin/python3' > $(CURDIR)/debian/cx-core/usr/bin/cx; \
		echo 'from cx.cli import main' >> $(CURDIR)/debian/cx-core/usr/bin/cx; \
		echo 'if __name__ == "__main__":' >> $(CURDIR)/debian/cx-core/usr/bin/cx; \
		echo '    main()' >> $(CURDIR)/debian/cx-core/usr/bin/cx; \
		chmod 755 $(CURDIR)/debian/cx-core/usr/bin/cx; \
	fi

override_dh_auto_clean:
	dh_auto_clean
	rm -rf build dist *.egg-info .eggs

override_dh_python3:
	dh_python3 --shebang=/usr/bin/python3
