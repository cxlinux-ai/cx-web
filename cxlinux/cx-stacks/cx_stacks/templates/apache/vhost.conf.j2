<VirtualHost *:80>
    ServerName {{ domain }}
{% if server_alias %}
    ServerAlias {{ server_alias }}
{% endif %}
    DocumentRoot {{ web_root }}

    <Directory {{ web_root }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

{% if php_fpm %}
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/{{ php_version | default('php8.3') }}-fpm.sock|fcgi://localhost"
    </FilesMatch>
{% endif %}

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"

    ErrorLog ${APACHE_LOG_DIR}/{{ domain }}_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ domain }}_access.log combined
</VirtualHost>

{% if ssl %}
<VirtualHost *:443>
    ServerName {{ domain }}
{% if server_alias %}
    ServerAlias {{ server_alias }}
{% endif %}
    DocumentRoot {{ web_root }}

    SSLEngine on
    SSLCertificateFile {{ ssl_cert }}
    SSLCertificateKeyFile {{ ssl_key }}

    <Directory {{ web_root }}>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

{% if php_fpm %}
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/run/php/{{ php_version | default('php8.3') }}-fpm.sock|fcgi://localhost"
    </FilesMatch>
{% endif %}

    # Security headers
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"

    ErrorLog ${APACHE_LOG_DIR}/{{ domain }}_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/{{ domain }}_ssl_access.log combined
</VirtualHost>
{% endif %}
